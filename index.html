<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
		#fixed-info-box {
		  position: absolute;
		  bottom: 20px;
		  right: 20px;
		  width: 250px;
		  background-color: rgba(255, 255, 255, 0.9);
		  padding: 10px 15px;
		  border: 1px solid #ccc;
		  border-radius: 5px;
		  font-family: Calibri, sans-serif;
		  font-size: 14px;
		  color: #333;
		  z-index: 1000;
		  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
		}

		#close-btn {
		  position: absolute;
		  top: 5px;
		  right: 8px;
		  background: transparent;
		  border: none;
		  font-size: 18px;
		  font-weight: bold;
		  color: #666;
		  cursor: pointer;
		}
        </style>
        <title>TPL Branches Across Neighborhoods</title>
    </head>
    <body>
        <div id="map">
        </div>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="js/leaflet-search.js"></script>
        <script src="data/neigh_tpl_1km_1.js"></script>
        <script src="data/TPL_branches_2.js"></script>
        <script>
        var map = L.map('map', {
            zoomControl:false, maxZoom:28, minZoom:1
        }).fitBounds([[43.574118363844335,-79.77065661562442],[43.86230260682453,-78.98388192926458]]);
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        // remove popup's row if "visible-with-data"
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        // add class to format popup if it contains media
		function addClassToPopupIfMedia(content, popup) {
			var tempDiv = document.createElement('div');
			tempDiv.innerHTML = content;
			if (tempDiv.querySelector('td img')) {
				popup._contentNode.classList.add('media');
					// Delay to force the redraw
					setTimeout(function() {
						popup.update();
					}, 10);
			} else {
				popup._contentNode.classList.remove('media');
			}
		}
        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        var measureControl = new L.Control.Measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares'
        });
        measureControl.addTo(map);
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
        }
        map.createPane('pane_OpenStreetMap_0');
        map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
        var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OpenStreetMap_0',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_OpenStreetMap_0;
        map.addLayer(layer_OpenStreetMap_0);
        function pop_neigh_tpl_1km_1(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <th>Area ID:</th><td>' + (feature.properties['_id'] !== null ? autolinker.link(String(feature.properties['_id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th>Area Name:</th><td>' + (feature.properties['AREA_NAME'] !== null ? autolinker.link(String(feature.properties['AREA_NAME']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th>Branches Within 1 km:</th><td>' + (feature.properties['NAME_count'] !== null ? autolinker.link(String(feature.properties['NAME_count']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_neigh_tpl_1km_1_0(feature) {
            switch(String(feature.properties['NAME_count'])) {
                case '0':
                    return {
                pane: 'pane_neigh_tpl_1km_1',
                opacity: 1,
                color: 'rgba(35,35,35,0.8)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(247,251,255,0.8)',
                interactive: true,
            }
                    break;
                case '1':
                    return {
                pane: 'pane_neigh_tpl_1km_1',
                opacity: 1,
                color: 'rgba(35,35,35,0.8)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(223,236,247,0.8)',
                interactive: true,
            }
                    break;
                case '2':
                    return {
                pane: 'pane_neigh_tpl_1km_1',
                opacity: 1,
                color: 'rgba(35,35,35,0.8)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(200,220,240,0.8)',
                interactive: true,
            }
                    break;
                case '3':
                    return {
                pane: 'pane_neigh_tpl_1km_1',
                opacity: 1,
                color: 'rgba(35,35,35,0.8)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(163,204,227,0.8)',
                interactive: true,
            }
                    break;
                case '4':
                    return {
                pane: 'pane_neigh_tpl_1km_1',
                opacity: 1,
                color: 'rgba(35,35,35,0.8)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(115,178,216,0.8)',
                interactive: true,
            }
                    break;
                case '5':
                    return {
                pane: 'pane_neigh_tpl_1km_1',
                opacity: 1,
                color: 'rgba(35,35,35,0.8)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(74,151,201,0.8)',
                interactive: true,
            }
                    break;
                case '6':
                    return {
                pane: 'pane_neigh_tpl_1km_1',
                opacity: 1,
                color: 'rgba(35,35,35,0.8)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(41,121,185,0.8)',
                interactive: true,
            }
                    break;
                case '8':
                    return {
                pane: 'pane_neigh_tpl_1km_1',
                opacity: 1,
                color: 'rgba(35,35,35,0.8)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(13,88,161,0.8)',
                interactive: true,
            }
                    break;
            }
        }
        map.createPane('pane_neigh_tpl_1km_1');
        map.getPane('pane_neigh_tpl_1km_1').style.zIndex = 401;
        map.getPane('pane_neigh_tpl_1km_1').style['mix-blend-mode'] = 'normal';
        var layer_neigh_tpl_1km_1 = new L.geoJson(json_neigh_tpl_1km_1, {
            attribution: '',
            interactive: true,
            dataVar: 'json_neigh_tpl_1km_1',
            layerName: 'layer_neigh_tpl_1km_1',
            pane: 'pane_neigh_tpl_1km_1',
            onEachFeature: pop_neigh_tpl_1km_1,
            style: style_neigh_tpl_1km_1_0,
        });
        bounds_group.addLayer(layer_neigh_tpl_1km_1);
        map.addLayer(layer_neigh_tpl_1km_1);
        function pop_TPL_branches_2(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <th>Branch Name:</th><td>' + (feature.properties['Name'] !== null ? autolinker.link(String(feature.properties['Name']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['description'] !== null ? autolinker.link(String(feature.properties['description']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_TPL_branches_2_0() {
            return {
                pane: 'pane_TPL_branches_2',
                radius: 3.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(227,26,28,1.0)',
                interactive: true,
            }
        }
        map.createPane('pane_TPL_branches_2');
        map.getPane('pane_TPL_branches_2').style.zIndex = 402;
        map.getPane('pane_TPL_branches_2').style['mix-blend-mode'] = 'normal';
        var layer_TPL_branches_2 = new L.geoJson(json_TPL_branches_2, {
            attribution: '',
            interactive: true,
            dataVar: 'json_TPL_branches_2',
            layerName: 'layer_TPL_branches_2',
            pane: 'pane_TPL_branches_2',
            onEachFeature: pop_TPL_branches_2,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.circleMarker(latlng, style_TPL_branches_2_0(feature));
            },
        });
        bounds_group.addLayer(layer_TPL_branches_2);
        map.addLayer(layer_TPL_branches_2);
        var overlaysTree = [
            {label: '<img src="legend/TPL_branches_2.png" /> Library Branches', layer: layer_TPL_branches_2},
            {label: 'Neighborhoods (count of nearby branches ≤1 km)<br /><table><tr><td style="text-align: center;"><img src="legend/neigh_tpl_1km_1_00.png" /></td><td>0</td></tr><tr><td style="text-align: center;"><img src="legend/neigh_tpl_1km_1_11.png" /></td><td>1</td></tr><tr><td style="text-align: center;"><img src="legend/neigh_tpl_1km_1_22.png" /></td><td>2</td></tr><tr><td style="text-align: center;"><img src="legend/neigh_tpl_1km_1_33.png" /></td><td>3</td></tr><tr><td style="text-align: center;"><img src="legend/neigh_tpl_1km_1_44.png" /></td><td>4</td></tr><tr><td style="text-align: center;"><img src="legend/neigh_tpl_1km_1_55.png" /></td><td>5</td></tr><tr><td style="text-align: center;"><img src="legend/neigh_tpl_1km_1_66.png" /></td><td>6</td></tr><tr><td style="text-align: center;"><img src="legend/neigh_tpl_1km_1_87.png" /></td><td>8</td></tr></table>', layer: layer_neigh_tpl_1km_1},
            {label: "OpenStreetMap", layer: layer_OpenStreetMap_0},]
        var lay = L.control.layers.tree(null, overlaysTree,{
            //namedToggle: true,
            //selectorBack: false,
            //closedSymbol: '&#8862; &#x1f5c0;',
            //openedSymbol: '&#8863; &#x1f5c1;',
            //collapseAll: 'Collapse all',
            //expandAll: 'Expand all',
            collapsed: true,
        });
        lay.addTo(map);
        setBounds();
        var i = 0;
        layer_neigh_tpl_1km_1.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['AREA_NAME'] !== null?String('<div style="color: #323232; font-size: 10pt; font-family: \'Calibri\', sans-serif;">' + layer.feature.properties['AREA_NAME']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_neigh_tpl_1km_1'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        map.addControl(new L.Control.Search({
            layer: layer_TPL_branches_2,
            initial: false,
            hideMarkerOnCollapse: true,
            propertyName: 'Name'}));
        if (typeof url === 'undefined') {
            document.getElementsByClassName('search-button')[0].className += ' fa fa-binoculars';
        } else {
            document.getElementsByClassName('search-button')[1].className += ' fa fa-binoculars';
        }
        resetLabels([layer_neigh_tpl_1km_1]);
        map.on("zoomend", function(){
            resetLabels([layer_neigh_tpl_1km_1]);
        });
        map.on("layeradd", function(){
            resetLabels([layer_neigh_tpl_1km_1]);
        });
        map.on("layerremove", function(){
            resetLabels([layer_neigh_tpl_1km_1]);
        });
		//Mouseover effect for polygons
		layer_neigh_tpl_1km_1.eachLayer(function(layer) {
			layer.on('mouseover', function () {
				layer.setStyle({
					color: 'orange',
					weight: 2
				});
				layer.bringToFront();
			});

			layer.on('mouseout', function () {
				layer.setStyle({
					color: 'black',
					weight: 1
				});
			});
		});
		//Mouseover effect for points
		layer_TPL_branches_2.eachLayer(function(layer) {
			layer.on('mouseover', function () {
				layer.setStyle({
					color: 'orange',
					weight: 2
				});
				layer.bringToFront();
			});

			layer.on('mouseout', function () {
				layer.setStyle({
					color: 'black',
					weight: 1
				});
			});
		});
        </script>
		<div id="fixed-info-box">
		  <button id="close-btn" title="Close">×</button>
		  <span style="display: block; text-align: center;">
			<strong>Toronto Public Lobrary Branches Across Neighborhoods</strong><br><i>Created by <a href="https://tinyurl.com/pshahidi-HGIS" target="_blank">Pouyan Shahidi</i></a>
		  </span>
		  <p>This map displays the locations of Toronto Public Library (TPL) branches overlaid on the city’s official neighborhood boundaries. Each neighborhood is shaded in graduated tones of blue based on the number of TPL branches located inside or up to 1 km from its area. Click on any neighborhood or branch to view detailed information.<br><strong><u></p><p>Data Sources</u></strong><br>1. City of Toronto. <a href="https://open.toronto.ca/dataset/toronto-public-library-branch-locations/" target="_blank"><i>Toronto Public Library Branch Locations<i></a>. Open Data Portal. Accessed 12 Nov. 2025.<br>2. City of Toronto. <a href="https://open.toronto.ca/dataset/neighbourhoods/" target="_blank"><i>Neighbourhoods</i></a>. Open Data Portal, 1998–2025. Accessed 10 Nov. 2025.</p>
		</div>
		<script>
		document.addEventListener("DOMContentLoaded", function() {
		  document.getElementById("close-btn").addEventListener("click", function() {
			document.getElementById("fixed-info-box").style.display = "none";
		  });
		});
		</script>
	</body>
</html>